<!-- Contenedor principal -->
<div class="page-container">
  
  <!-- Encabezado con información del catálogo -->
  <div class="content-section">
    <mat-card class="card-gradient">
      <mat-card-header>
        <mat-card-title class="card-title-with-icon">
          <mat-icon>admin_panel_settings</mat-icon>
          Catálogo de Perfiles
        </mat-card-title>
        <mat-card-subtitle>
          Administración y gestión de perfiles de usuario del sistema
        </mat-card-subtitle>
      </mat-card-header>
    </mat-card>
  </div>

  <!-- Barra de herramientas -->
  <div class="content-section">
    <mat-card class="card-standard">
      <div class="toolbar-content">
        <!-- Buscador -->
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar perfiles</mat-label>
          <input matInput 
                 [(ngModel)]="searchTerm"
                 (input)="applyFilter()"
                 placeholder="Nombre del perfil..."
                 autocomplete="off">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <!-- Botón Nuevo Perfil -->
        <button mat-raised-button 
                color="primary" 
                (click)="showNewForm()"
                class="action-button">
          <mat-icon>add</mat-icon>
          Nuevo Perfil
        </button>
      </div>
    </mat-card>
  </div>

  <!-- Contenido principal -->
  <div class="content-section">
    @if (loading) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando perfiles...</p>
      </div>
    } @else {
      @if (showForm) {
        <!-- Formulario de creación/edición -->
        <div class="content-section">
        <mat-card class="card-accent">
          <mat-card-header>
            <mat-card-title>
              {{ isEditing ? 'Editar Perfil' : 'Nuevo Perfil' }}
            </mat-card-title>
          </mat-card-header>
          
          <mat-card-content>
            <form [formGroup]="perfilForm" (ngSubmit)="onSubmit()">
              <div class="form-row">
                <mat-form-field appearance="outline" class="field-half">
                  <mat-label>Nombre del Perfil</mat-label>
                  <input matInput 
                         formControlName="perfil"
                         placeholder="Ej: Administrador, Cliente, Supervisor"
                         autocomplete="off">
                  @if (perfil?.hasError('required')) {
                    <mat-error>
                      El nombre del perfil es requerido
                    </mat-error>
                  }
                  @if (perfil?.hasError('maxlength')) {
                    <mat-error>
                      El nombre no puede exceder 255 caracteres
                    </mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="field-half">
                  <mat-label>Descripción</mat-label>
                  <textarea matInput 
                           formControlName="descripcion"
                           placeholder="Descripción del perfil"
                           rows="3"
                           autocomplete="off"></textarea>
                  @if (descripcion?.hasError('required')) {
                    <mat-error>
                      La descripción es requerida
                    </mat-error>
                  }
                  @if (descripcion?.hasError('maxlength')) {
                    <mat-error>
                      La descripción no puede exceder 500 caracteres
                    </mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="field-half">
                  <mat-label>Empresas Asignadas</mat-label>
                  <mat-select formControlName="empresasIds" multiple>
                    @for (empresa of empresas; track empresa.empresaId) {
                      <mat-option [value]="empresa.empresaId">
                        {{ empresa.razonSocial }}
                      </mat-option>
                    }
                  </mat-select>
                  <mat-hint>Seleccione una o más empresas para el perfil</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="field-half">
                  <mat-label>Acciones Asignadas</mat-label>
                  <mat-select formControlName="accionesIds" multiple>
                    @for (accion of acciones; track accion.codAccion) {
                      <mat-option [value]="accion.codAccion">
                        {{ accion.descripcion }}
                      </mat-option>
                    }
                  </mat-select>
                  <mat-hint>Seleccione una o más acciones para el perfil</mat-hint>
                </mat-form-field>
              </div>
            </form>
          </mat-card-content>

          <mat-card-actions class="form-actions">
            <button mat-button 
                    type="button" 
                    (click)="cancelForm()"
                    class="btn-cancel">
              <mat-icon>cancel</mat-icon>
              Cancelar
            </button>
            
            <button mat-raised-button 
                    color="primary"
                    (click)="onSubmit()"
                    [disabled]="perfilForm.invalid"
                    class="btn-primary">
              <mat-icon>{{ isEditing ? 'save' : 'add' }}</mat-icon>
              {{ isEditing ? 'Actualizar' : 'Crear' }} Perfil
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
      }
        <!-- Tabla de perfiles -->
        <div class="content-section">
        <mat-card class="card-standard">
          <mat-card-header>
            <mat-card-title>Lista de Perfiles</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <div class="table-container">
              @if (loading) {
                <div class="loading-state">
                  <mat-icon class="loading-icon">refresh</mat-icon>
                  <h3>Cargando perfiles...</h3>
                  <p>Por favor espere mientras se cargan los datos</p>
                </div>
              } @else if (dataSource.data.length === 0) {
                <div class="empty-state">
                  <mat-icon>admin_panel_settings</mat-icon>
                  <h3>No hay perfiles registrados</h3>
                  <p>Comienza agregando el primer perfil al sistema</p>
                </div>
              } @else {
                <div>
                  <table mat-table [dataSource]="dataSource" class="data-table" matSort>
                    
                    <!-- Columna Perfil -->
                    <ng-container matColumnDef="perfil">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Perfil</th>
                      <td mat-cell *matCellDef="let perfil">
                        <div class="info-group">
                          <span class="info-primary">{{ perfil.perfil }}</span>
                          <span class="info-secondary">ID: {{ perfil.perfilId }}</span>
                        </div>
                      </td>
                    </ng-container>

                    <!-- Columna Descripción -->
                    <ng-container matColumnDef="descripcion">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Descripción</th>
                      <td mat-cell *matCellDef="let perfil">
                        <span class="info-primary">{{ perfil.descripcion || 'Sin descripción' }}</span>
                      </td>
                    </ng-container>

                    <!-- Columna Empresas -->
                    <ng-container matColumnDef="empresas">
                      <th mat-header-cell *matHeaderCellDef>Empresas</th>
                      <td mat-cell *matCellDef="let perfil">
                        @if (!perfil.perfilEmpresas || perfil.perfilEmpresas.length === 0) {
                          <span class="info-secondary">Sin empresas</span>
                        } @else {
                          <span class="info-primary">{{ perfil.perfilEmpresas.length }} empresa(s)</span>
                        }
                      </td>
                    </ng-container>

                    <!-- Columna Acciones Asignadas -->
                    <ng-container matColumnDef="acciones">
                      <th mat-header-cell *matHeaderCellDef>Acciones Asignadas</th>
                      <td mat-cell *matCellDef="let perfil">
                        @if (!perfil.perfilAccions || perfil.perfilAccions.length === 0) {
                          <span class="info-secondary">Sin acciones</span>
                        } @else {
                          <span class="info-primary">{{ perfil.perfilAccions.length }} acción(es)</span>
                        }
                      </td>
                    </ng-container>

                    <!-- Columna Acciones de Tabla -->
                    <ng-container matColumnDef="acciones_btn">
                      <th mat-header-cell *matHeaderCellDef>Acciones</th>
                      <td mat-cell *matCellDef="let perfil">
                        <div class="actions-container">
                          <button mat-icon-button 
                                  color="primary"
                                  (click)="editPerfil(perfil)"
                                  matTooltip="Editar perfil">
                            <mat-icon>edit</mat-icon>
                          </button>
                        </div>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                        class="usuario-row"></tr>
                  </table>

                  <!-- Paginador -->
                  <mat-paginator 
                    [pageSizeOptions]="pageSizeOptions"
                    [pageSize]="pageSize"
                    showFirstLastButtons>
                  </mat-paginator>
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    }
  </div>
</div>
